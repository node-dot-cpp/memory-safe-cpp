

Running checker tools
=====================

See file [CHECKER-QUICK-START.md](CHECKER-QUICK-START.md) for a very first, very quick sample use.

This document covers deeper info and more complex use cases.

We will assume that `safememory-checker` and `safememory-library-db` tools are already built and in the `PATH`.


Safe library database
---------------------

Rule 8 of STATIC-CHECKS.md states:

	[Rule S8] Prohibit functions except for those safe ones

In order to enforce such rule, exists the safe library database.
The safe library database is json serialized file used by `safememory-checker` and generated by `safememory-library-db`, the file name is usualy `safe_library.json`

When `safememory-checker` is run, we can pass a database path in the command line (`-safe-library-db=<path>`), or the tool will try to automatically find it in the same path of the source file, or any parent folder.
If no database is found, the tool will run anyway, but all functions and classes defined in _system_ libraries will be considered as __unsafe__


To generate a safe library database, we use `safememory-library-db` tool. This tool will read a normal C++ header file (please use .hpp extension). Example:

	namespace fmt {
	namespace v5 {
		void print();
	}	
	}
	void make_owning();

	class owning_ptr;
	class naked_ptr;

This will create a safe library database that has the given functions and classes as safe.


Compilation database
--------------------

Compilation database is native to `clang` and all tools based on clang's tooling. The idea is to have all compiler flags and options stored in a single place, so any tool that is runned over the code will use exactly the same set of options.
This is mostly important for defined symbols and include paths.

When we run `safememory-checker` we have three ways to pass all the compiler flags and settings to correctly pre-process the source code. These tree options are common to all tools based on clang tooling.

1. Use a json compilation database. Please see https://clang.llvm.org/docs/JSONCompilationDatabase.html
2. Put a `compile_flags.txt` with one flag per line in the same folder of the source code.
3. On the command line itself, use a double hypen `--` and put all command line options to the parser / compiler after that. The double hypen must be present even if no option is passed so the compiler doesn't try to find database file.


On examples on this document, we will use option __3__ to make it visible.
Test cases use option __2__ and sample `compile_flags.txt` can be seen there.
Finally option __1__ is usually used by project built with `cmake` or similar tool that can automatically generate the `compile_commands.json` file.


Checking code
-------------
To run the tool on a simple file (without any `#include`), and assuming that `safe_library.json` is in the same folder, just run:

	safememory-checker file.cpp --

If safe library database is at a different place, add command line argument:

	safememory-checker file.cpp -safe-library-db=/path/to/safe_library.json --


If we need to include some library (like `fmt` or `safe_ptr`) then we add `isystem` after the double hypen with the include path

	safememory-checker file.cpp -- -isystem /absolute/path/to/library/include/

After the double hypen, we can also add any compiler flag our code may need, like defines

	safememory-checker file.cpp -- -DNDEBUG


It is important that the tool gets exactly the same code than the compiler will see after preprocessing.
Bacuse of that, is important to have the same set of includes and defines.

